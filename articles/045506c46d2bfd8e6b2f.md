---
title: "Excelãƒã‚¯ãƒ­æŠ½å‡ºã‚¹ã‚¯ãƒªãƒ—ãƒˆ"
emoji: "ğŸ‘Œ"
type: "tech"  # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [ "JScript", "ExcelVBA" ]
published: true
created_at: "2016-08-08T01:05:00+09:00"
updated_at: "2016-08-20T15:35:50+09:00"
---
# æ¦‚è¦
Excelã‹ã‚‰ãƒã‚¯ãƒ­ã®å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å¤–éƒ¨ã«å¸ã„å‡ºã™ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚

ä»•äº‹ã®é–¢ä¿‚ã§Excel VBAãƒã‚¯ãƒ­ã‚’è§¦ã‚‹å¿…è¦ãŒã‚ã‚Šã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã—ãŸã„ãªã¨æ€ã£ãŸã‘ã©Excelè‡ªä½“ã‚’ç®¡ç†ä¸‹ã«ãŠã„ã¦ã‚‚ã‚ã¾ã‚Šæ„å‘³ã¯ãªã‹ã£ãŸãƒ»ãƒ»ãƒ»ã€‚ï¼ˆã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®å·®åˆ†ã¨ã‹å–ã‚Œãªã„ã§ã™ã‹ã‚‰ã­ãƒ»ãƒ»ãƒ»ï¼‰
ã¨ã„ã†ã‚ã‘ã§ãƒã‚¯ãƒ­ã ã‘å¼•ã£ã“æŠœã„ã¦ãƒ†ã‚­ã‚¹ãƒˆåŒ–ã—ã¦ãã‚Œã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’çµ„ã¿ã¾ã—ãŸã€‚WSHã§å‹•ãã¾ã™ã€‚

æ›¸ã„ã¦ã„ã¦æ°—ã«ãªã£ãŸãŒã€Excel VBAã¨ãƒã‚¯ãƒ­ã®é•ã„ã£ã¦ãªã«ï¼Ÿï¼Ÿã¡ã‚ƒã‚“ã¨åŒºåˆ¥ã™ã¹ãã ã‚ã†ã‹ãƒ»ãƒ»ãƒ»ã€‚

# åˆ©ç”¨æº–å‚™
(Excel2003ä»¥å‰ã®å ´åˆ)
ãƒ„ãƒ¼ãƒ«ï¼ãƒã‚¯ãƒ­ï¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ä¿¡é ¼ã§ãã‚‹ç™ºè¡Œå…ƒï¼[Visual Basic ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ä¿¡é ¼ã™ã‚‹]ã‚’ã‚ªãƒ³
(Excel2007ä»¥é™ã®å ´åˆ)
ãƒªãƒœãƒ³ã®ã€Œé–‹ç™ºã€ã‚¿ãƒ–ï¼ãƒã‚¯ãƒ­ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼[VBAãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ‡ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ä¿¡é ¼ã™ã‚‹]ã‚’ã‚ªãƒ³

# ä½¿ã„æ–¹
1. ä¸‹è¨˜/* --- è¨­å®š --- */ã®æŠ½å‡ºå…ƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã€æŠ½å‡ºã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒç½®ã„ã¦ã‚ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã®çµ¶å¯¾ãƒ‘ã‚¹ã‚’æŒ‡å®šã™ã‚‹ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ãªããƒ•ã‚©ãƒ«ãƒ€ã‚’å¿…ãšæŒ‡å®šã—ã€æŠ½å‡ºå¯¾è±¡ä»¥å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ ¼ç´ã—ã¦ãŠã‹ãªã„ã“ã¨ã€‚ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã«æ°—ã‚’ã¤ã‘ã‚‹ã“ã¨ã€‚
1. å½“ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã€‚å®Ÿè¡Œã™ã‚‹ã¨ã‚¨ã‚¯ã‚»ãƒ«ç”»é¢ãŒé–‹ã„ãŸã‚Šé–‰ã˜ãŸã‚Šã™ã‚‹ã€‚å®Ÿè¡Œä¸­ã¯ä½•ã‚‚æ“ä½œã—ãªã„ã“ã¨ã€‚
1. çµ‚äº†å¾Œã€ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã«æŠ½å‡ºã•ã‚ŒãŸã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹äº‹ã‚’ç¢ºèªã€‚æŠ½å‡ºå¯¾è±¡ã®ãƒ•ã‚©ãƒ«ãƒ€åã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã€‚

# å‚è€ƒ
sakura ã‚¨ãƒ‡ã‚£ã‚¿ã§ã®ã‚³ãƒ¡ãƒ³ãƒˆç©ºç™½è¡Œã‚’é™¤ã„ãŸGREPæ­£è¦è¡¨ç¾
`\s*[\S&&[^('|\r\n)]]`

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

```js:ExtractExcelMacro.js

/* -------------------------------- è¨­å®š -------------------------------- */

// æŠ½å‡ºå…ƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª(ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã«æ³¨æ„ã€‚ä¾‹)ã€Œ\ã€â‡’ã€Œ\\ã€ï¼‰
var src_dir = "C:\\ExcelMacro";

// æŠ½å‡ºå…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
var ext_dir = WScript.CreateObject("WScript.Shell").SpecialFolders("Desktop");

// Excelãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ï¼ŒSendKeysç”¨ã®è¨˜æ³•ã§è¨˜è¿°
var pass_string = "p@ssword";

/* -------------------------------- å‡¦ç† -------------------------------- */

var objFSO = WScript.CreateObject("Scripting.FileSystemObject");

access_dir(src_dir, ext_dir + "\\" + objFSO.GetFileName(src_dir));

// ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å†å¸°çš„ã«ã‚¢ã‚¯ã‚»ã‚¹
function access_dir(src_path, vcm_path)
{
	if (!objFSO.FolderExists(vcm_path)) objFSO.CreateFolder(vcm_path);

	var folder = objFSO.GetFolder(src_path);

	var e1 = new Enumerator(folder.Files);
	for (e1.moveFirst(); !e1.atEnd(); e1.moveNext())
	{
		var file_path = src_path + "\\" + objFSO.GetFileName(e1.item().Name);
		var vacuum_dir = vcm_path + "\\" + objFSO.GetBaseName(e1.item().Name);

		if (objFSO.GetExtensionName(file_path) == "xls" || objFSO.GetExtensionName(file_path) == "xlsm")
		{
			extract_vba(file_path, vacuum_dir);
		}
	}

	var e2 = new Enumerator(folder.SubFolders);
	for (e2.moveFirst(); !e2.atEnd(); e2.moveNext())
	{
		var file_path = src_path + "\\" + objFSO.GetFileName(e2.item().Name);
		var vacuum_dir = vcm_path + "\\" + objFSO.GetFileName(e2.item().Name);

		access_dir(file_path, vacuum_dir);
	}
}

// VBAã®æŠ½å‡º
function extract_vba(file_path, vacuum_dir_path)
{
	if (!objFSO.FolderExists(vacuum_dir_path)) objFSO.CreateFolder(vacuum_dir_path);

	// ãƒ–ãƒƒã‚¯ã‚’é–‹ã
	var excel = WScript.CreateObject("Excel.Application");
	excel.Visible = true;
	excel.EnableEvents = false;
	excel.Workbooks.Open( file_path );
	var book = excel.Workbooks( excel.Workbooks.Count );
	WScript.CreateObject("WScript.Shell").AppActivate( excel.Caption );

	/* ---------- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è§£é™¤ ---------- */

	var ws = WScript.CreateObject("WScript.Shell");

	// Visual Basic Editorã‚’é–‹ãï¼Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
	book.VBProject.VBE.Windows(1).SetFocus();
	WScript.Sleep( 1000 );

	// ä¸€ç•ªä¸Šã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
	ws.SendKeys( "{TAB}" );
	WScript.Sleep( 200 );

	// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹
	ws.SendKeys( "{ENTER}" );
	WScript.Sleep( 500 );

	// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›
	ws.SendKeys( pass_string );
	WScript.Sleep( 200 );
	ws.SendKeys( "{ENTER}" );
	WScript.Sleep( 500 );

	/* ---------- ãƒã‚¯ãƒ­æŠ½å‡º ---------- */

	// ãƒ–ãƒƒã‚¯å†…ã®ãƒã‚¯ãƒ­ã®å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹
	var e = new Enumerator( book.VBProject.VBComponents );
	for( e.moveFirst() ; ! e.atEnd() ;  e.moveNext() )
	{
		// ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å–å¾—
		var vba_module = e.item();

		// ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå…ˆãƒ‘ã‚¹ã‚’æ±ºå®š
		var bas_path = vacuum_dir_path + "\\" + vba_module.Name;
		switch( vba_module.Type )
		{
			case 2:
				bas_path = bas_path + ".cls";
				break;
			case 3:
				bas_path = bas_path + ".frm";
				break;
			default:
				bas_path = bas_path + ".bas";
				break;
		}

		// ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
		vba_module.Export( bas_path );
	}

	// Excelã‚’é–‰ã˜ã¦çµ‚äº†
	excel.DisplayAlerts = false;
	excel.Quit();
	excel = null;
}
```
